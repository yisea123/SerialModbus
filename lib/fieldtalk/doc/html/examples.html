<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
<title>FieldTalk Modbus Master C++ Library: Examples</title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
<style>
h2 a, h3 a {font-weight:bold; color:black;}
h2 a:hover, h3 a:hover {text-decoration:none;}
</style>
</head><body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Introduction</span></a></li>
      <li class="current"><a href="pages.html"><span>Chapters</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>Examples </h1>  </div>
</div>
<div class="contents">
<h2><a class="anchor" id="example1"></a>
Serial Example</h2>
<p>The following example sersimple.cpp shows how to configure a serial Modbus protocol and read values:</p>
<div class="fragment"><pre class="fragment">
<span class="comment">// HM platform detection</span>
<span class="preprocessor">#include &quot;hmplatf.h&quot;</span>

<span class="comment">// Platform header</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#if defined(__WIN32__)</span>
<span class="preprocessor"></span><span class="preprocessor">#  include &lt;windows.h&gt;</span>
<span class="preprocessor">#elif defined(__UNIX__)</span>
<span class="preprocessor"></span><span class="preprocessor">#  include &lt;unistd.h&gt;</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="comment">// Include FieldTalk package header</span>
<span class="preprocessor">#include &quot;MbusAsciiMasterProtocol.hpp&quot;</span>
<span class="preprocessor">#include &quot;MbusRtuMasterProtocol.hpp&quot;</span>


<span class="comment">/*****************************************************************************</span>
<span class="comment"> * Gobal data</span>
<span class="comment"> *****************************************************************************/</span>

<span class="preprocessor">#if defined(__WIN32__)</span>
<span class="preprocessor"></span><span class="preprocessor">#  if defined (_UNICODE)</span>
<span class="preprocessor"></span>   TCHAR *portName = L<span class="stringliteral">&quot;COM1:&quot;</span>;
<span class="preprocessor">#  else</span>
<span class="preprocessor"></span>   <span class="keywordtype">char</span> *portName = <span class="stringliteral">&quot;COM1:&quot;</span>;
<span class="preprocessor">#  endif</span>
<span class="preprocessor"></span><span class="preprocessor">#elif defined(__LINUX__)</span>
<span class="preprocessor"></span>   <span class="keywordtype">char</span> *portName = <span class="stringliteral">&quot;/dev/ttyS0&quot;</span>;
<span class="preprocessor">#elif defined(__MACOSX__)</span>
<span class="preprocessor"></span>   <span class="keywordtype">char</span> *portName = <span class="stringliteral">&quot;/dev/ttys0&quot;</span>;
<span class="preprocessor">#elif defined(__QNX__)</span>
<span class="preprocessor"></span>   <span class="keywordtype">char</span> *portName = <span class="stringliteral">&quot;/dev/ser1&quot;</span>;
<span class="preprocessor">#elif defined(__VXWORKS__)</span>
<span class="preprocessor"></span>   <span class="keywordtype">char</span> *portName = <span class="stringliteral">&quot;/tyCo/0&quot;</span>;
<span class="preprocessor">#elif defined(__SOLARIS__)</span>
<span class="preprocessor"></span>   <span class="keywordtype">char</span> *portName = <span class="stringliteral">&quot;/dev/ttya&quot;</span>;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span><span class="preprocessor">#  error Unknown serial port name, please add an entry for portName</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="comment">//MbusAsciiMasterProtocol mbusProtocol; // Use this declaration for ASCII</span>
<a class="code" href="classMbusRtuMasterProtocol.html" title="Modbus RTU Master Protocol class.">MbusRtuMasterProtocol</a> mbusProtocol; <span class="comment">// Use this declaration for RTU</span>


<span class="comment">/*****************************************************************************</span>
<span class="comment"> * Function implementation</span>
<span class="comment"> *****************************************************************************/</span>

<span class="keywordtype">void</span> openProtocol()
{
   <span class="keywordtype">int</span> result;

   result = mbusProtocol.<a class="code" href="classMbusRtuMasterProtocol.html#a2a35993d9eac99424e2ec2124053e430" title="Opens a Modbus RTU protocol and the associated serial port with specific port parameters.">openProtocol</a>(portName,
                                      19200L, <span class="comment">// Baudrate</span>
                                      8,      <span class="comment">// Databits</span>
                                      1,      <span class="comment">// Stopbits</span>
                                      2);     <span class="comment">// Even parity</span>
   <span class="keywordflow">if</span> (result != <a class="code" href="group__buserror.html#ga30cbe7caf80689adf2b4359abbddd046" title="Operation was successful.">FTALK_SUCCESS</a>)
   {
      fprintf(stderr, <span class="stringliteral">&quot;Error opening protocol: %s!\n&quot;</span>,
                       <a class="code" href="group__buserror.html#ga86619062eb7bb909d9600901b457143f" title="Translates a numeric error code into a description string.">getBusProtocolErrorText</a>(result));
      exit(EXIT_FAILURE);
   }
}


<span class="keywordtype">void</span> closeProtocol()
{
   mbusProtocol.<a class="code" href="classMbusSerialMasterProtocol.html#a99162acbde11d57faf6a154089e920cb" title="Closes an open protocol including any associated communication resources (com ports or sockets)...">closeProtocol</a>();
}


<span class="keywordtype">void</span> runPollLoop()
{
   <span class="keywordtype">short</span> dataArr[10];

   <span class="keywordflow">for</span> (;;)
   {
      <span class="keywordtype">int</span> i;
      <span class="keywordtype">int</span> result;

      result = mbusProtocol.<a class="code" href="classMbusMasterFunctions.html#aea74f35a7305faf154b3ee7a46d926f7" title="Modbus function 3, Read Holding Registers/Read Multiple Registers.">readMultipleRegisters</a>(1, 100,
                                                  dataArr,
                                                  <span class="keyword">sizeof</span>(dataArr) / 2);
      <span class="keywordflow">if</span> (result == <a class="code" href="group__buserror.html#ga30cbe7caf80689adf2b4359abbddd046" title="Operation was successful.">FTALK_SUCCESS</a>)
         <span class="keywordflow">for</span> (i = 0; i &lt; int(<span class="keyword">sizeof</span>(dataArr) / 2); i++)
            printf(<span class="stringliteral">&quot;[%d]: %hd\n&quot;</span>, 100 + i, dataArr[i]);
      <span class="keywordflow">else</span>
      {
         fprintf(stderr, <span class="stringliteral">&quot;%s!\n&quot;</span>, <a class="code" href="group__buserror.html#ga86619062eb7bb909d9600901b457143f" title="Translates a numeric error code into a description string.">getBusProtocolErrorText</a>(result));
         <span class="comment">// Stop for fatal errors</span>
         <span class="keywordflow">if</span> (!(result &amp; <a class="code" href="group__buserror.html#ga7a803e248c41302840874c176384b84c" title="Fieldbus protocol error class.">FTALK_BUS_PROTOCOL_ERROR_CLASS</a>))
            <span class="keywordflow">return</span>;
      }

<span class="preprocessor">#ifdef __WIN32__</span>
<span class="preprocessor"></span>      Sleep(1000);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      sleep(1);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>   }
}


<span class="preprocessor">#if defined(_WIN32_WCE)</span>
<span class="preprocessor"></span><span class="keywordtype">int</span> wmain()
<span class="preprocessor">#else</span>
<span class="preprocessor"></span><span class="keywordtype">int</span> main()
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>{
   openProtocol();

   runPollLoop();

   closeProtocol();
   <span class="keywordflow">return</span> (EXIT_SUCCESS);
}
</pre></div><h2><a class="anchor" id="example2"></a>
MODBUS/TCP Example</h2>
<p>The following example tcpsimple.cpp shows how to configure a MODBUS/TCP protocol and read values:</p>
<div class="fragment"><pre class="fragment">
<span class="comment">// Platform header</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;stdlib.h&gt;</span>

<span class="comment">// Include FieldTalk package header</span>
<span class="preprocessor">#include &quot;MbusTcpMasterProtocol.hpp&quot;</span>


<span class="comment">/*****************************************************************************</span>
<span class="comment"> * Gobal data</span>
<span class="comment"> *****************************************************************************/</span>

<span class="preprocessor">#if defined (_UNICODE)</span>
<span class="preprocessor"></span>TCHAR *hostName = L<span class="stringliteral">&quot;127.0.0.1&quot;</span>;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span><span class="keywordtype">char</span> *hostName = <span class="stringliteral">&quot;127.0.0.1&quot;</span>;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><a class="code" href="classMbusTcpMasterProtocol.html" title="MODBUS/TCP Master Protocol class.">MbusTcpMasterProtocol</a> mbusProtocol;


<span class="comment">/*****************************************************************************</span>
<span class="comment"> * Function implementation</span>
<span class="comment"> *****************************************************************************/</span>

<span class="keywordtype">void</span> openProtocol()
{
   <span class="keywordtype">int</span> result;

   result = mbusProtocol.<a class="code" href="classMbusTcpMasterProtocol.html#a4bd515ba5c6f5949a59673d0dbb54607" title="Connects to a MODBUS/TCP slave.">openProtocol</a>(hostName);
   <span class="keywordflow">if</span> (result != <a class="code" href="group__buserror.html#ga30cbe7caf80689adf2b4359abbddd046" title="Operation was successful.">FTALK_SUCCESS</a>)
   {
      fprintf(stderr, <span class="stringliteral">&quot;Error opening protocol: %s!\n&quot;</span>,
                       <a class="code" href="group__buserror.html#ga86619062eb7bb909d9600901b457143f" title="Translates a numeric error code into a description string.">getBusProtocolErrorText</a>(result));
      exit(EXIT_FAILURE);
   }
}


<span class="keywordtype">void</span> closeProtocol()
{
   mbusProtocol.<a class="code" href="classMbusTcpMasterProtocol.html#a99162acbde11d57faf6a154089e920cb" title="Closes a TCP/IP connection to a slave and releases any system resources associated with the connectio...">closeProtocol</a>();
}


<span class="keywordtype">void</span> runPollLoop()
{
   <span class="keywordtype">short</span> dataArr[10];

   <span class="keywordflow">for</span> (;;)
   {
      <span class="keywordtype">int</span> i;
      <span class="keywordtype">int</span> result;

      result = mbusProtocol.<a class="code" href="classMbusMasterFunctions.html#aea74f35a7305faf154b3ee7a46d926f7" title="Modbus function 3, Read Holding Registers/Read Multiple Registers.">readMultipleRegisters</a>(1, 100,
                                                  dataArr,
                                                  <span class="keyword">sizeof</span>(dataArr) / 2);
      <span class="keywordflow">if</span> (result == <a class="code" href="group__buserror.html#ga30cbe7caf80689adf2b4359abbddd046" title="Operation was successful.">FTALK_SUCCESS</a>)
         <span class="keywordflow">for</span> (i = 0; i &lt; int(<span class="keyword">sizeof</span>(dataArr) / 2); i++)
            printf(<span class="stringliteral">&quot;[%d]: %hd\n&quot;</span>, 100 + i, dataArr[i]);
      <span class="keywordflow">else</span>
      {
         fprintf(stderr, <span class="stringliteral">&quot;%s!\n&quot;</span>, <a class="code" href="group__buserror.html#ga86619062eb7bb909d9600901b457143f" title="Translates a numeric error code into a description string.">getBusProtocolErrorText</a>(result));
         <span class="comment">// Stop for fatal errors</span>
         <span class="keywordflow">if</span> (!(result &amp; <a class="code" href="group__buserror.html#ga7a803e248c41302840874c176384b84c" title="Fieldbus protocol error class.">FTALK_BUS_PROTOCOL_ERROR_CLASS</a>))
            <span class="keywordflow">return</span>;
      }

<span class="preprocessor">#ifdef __WIN32__</span>
<span class="preprocessor"></span>      Sleep(1000);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>      sleep(1);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>   }
}


<span class="preprocessor">#if defined(_WIN32_WCE)</span>
<span class="preprocessor"></span><span class="keywordtype">int</span> wmain()
<span class="preprocessor">#else</span>
<span class="preprocessor"></span><span class="keywordtype">int</span> main()
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>{
   openProtocol();

   runPollLoop();

   closeProtocol();
   <span class="keywordflow">return</span> (EXIT_SUCCESS);
}
</pre></div> </div>
<hr size="1"><address style="text-align: right;">
<small>
FieldTalk Modbus Master C++ Library
<br>
Draft Version
</small></address>
</body>
</html>

