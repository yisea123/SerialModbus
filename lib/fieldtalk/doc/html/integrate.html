<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
<title>FieldTalk Modbus Master C++ Library: How to integrate the Protocol in your Application</title>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
<style>
h2 a, h3 a {font-weight:bold; color:black;}
h2 a:hover, h3 a:hover {text-decoration:none;}
</style>
</head><body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Introduction</span></a></li>
      <li class="current"><a href="pages.html"><span>Chapters</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>How to integrate the Protocol in your Application </h1>  </div>
</div>
<div class="contents">
<h2><a class="anchor" id="serialintegrate"></a>
Using Serial Protocols</h2>
<p>Let's assume we want to talk to a Modbus slave device with slave address 1.</p>
<p>The registers for reading are in the reference range 4:00100 to 4:00119 and the registers for writing are in the range 4:00200 to 4:00219. The discretes for reading are in the reference range 0:00010 to 0:00019 and the discretes for writing are in the range 0:00020 to 0:00029.</p>
<p>1. Include the library header files </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &quot;MbusRtuMasterProtocol.hpp&quot;</span>
</pre></div><p>2. Device data profile definition</p>
<p>Define the data sets which reflects the slave's data profile by type and size: </p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">short</span> readRegSet[20];
<span class="keywordtype">short</span> writeRegSet[20];
<span class="keywordtype">int</span> readBitSet[20];
<span class="keywordtype">int</span> writeBitSet[20];
</pre></div><p>If you are using floats instead of 16-bit shorts define: </p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">float</span> readFloatSet[10];
<span class="keywordtype">float</span> writeFloatSet[10];
</pre></div><p> Note that because a float occupies two 16-bit registers the array size is half the size it would be for 16-bit shorts!</p>
<p>If you are using 32-bit ints instead of 16-bit shorts define: </p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">long</span> readLongSet[10];
<span class="keywordtype">long</span> writeLongSet[10];
</pre></div><p> Note that because a long occupies two 16-bit registers the array size is half the size it would be for 16-bit shorts!</p>
<p>3. Declare and instantiate a protocol object </p>
<div class="fragment"><pre class="fragment"><a class="code" href="classMbusRtuMasterProtocol.html" title="Modbus RTU Master Protocol class.">MbusRtuMasterProtocol</a> mbusProtocol;
</pre></div><p>4. Open the protocol </p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">int</span> result;

result = mbusProtocol.<a class="code" href="classMbusRtuMasterProtocol.html#a2a35993d9eac99424e2ec2124053e430" title="Opens a Modbus RTU protocol and the associated serial port with specific port parameters.">openProtocol</a>(portName,
                                   19200L, <span class="comment">// Baudrate</span>
                                   8,      <span class="comment">// Databits</span>
                                   1,      <span class="comment">// Stopbits</span>
                                   2);     <span class="comment">// Even parity</span>
<span class="keywordflow">if</span> (result != <a class="code" href="group__buserror.html#ga30cbe7caf80689adf2b4359abbddd046" title="Operation was successful.">FTALK_SUCCESS</a>)
{
   fprintf(stderr, <span class="stringliteral">&quot;Error opening protocol: %s!\n&quot;</span>,
                    <a class="code" href="group__buserror.html#ga86619062eb7bb909d9600901b457143f" title="Translates a numeric error code into a description string.">getBusProtocolErrorText</a>(result));
   exit(EXIT_FAILURE);
}
</pre></div><p>5. Perform the data transfer functions</p>
<ul>
<li>To read register values: <div class="fragment"><pre class="fragment">mbusProtocol.<a class="code" href="classMbusMasterFunctions.html#aea74f35a7305faf154b3ee7a46d926f7" title="Modbus function 3, Read Holding Registers/Read Multiple Registers.">readMultipleRegisters</a>(1, 100, readRegSet,
                                   <span class="keyword">sizeof</span>(readRegSet) / <span class="keyword">sizeof</span>(<span class="keywordtype">short</span>));
</pre></div></li>
<li>To write a single register value: <div class="fragment"><pre class="fragment">mbusProtocol.<a class="code" href="classMbusMasterFunctions.html#a87c4cbb3073f7caa117e1745e9de731b" title="Modbus function 6, Preset Single Register/Write Single Register.">writeSingleRegister</a>(1, 200, 1234);
</pre></div></li>
<li>To write mutliple register values: <div class="fragment"><pre class="fragment">mbusProtocol.<a class="code" href="classMbusMasterFunctions.html#a8ba7b9150d6b642f44ff1f94679e0dc4" title="Modbus function 16 (10 Hex), Preset Multiple Registers/Write Multiple Registers.">writeMultipleRegisters</a>(1, 200, writeRegSet,
                                    <span class="keyword">sizeof</span>(writeRegSet) / <span class="keyword">sizeof</span>(<span class="keywordtype">short</span>));
</pre></div></li>
<li>To read discrete values: <div class="fragment"><pre class="fragment">mbusProtocol.<a class="code" href="classMbusMasterFunctions.html#ac9cc7e597a6c7036746a15e159d05341" title="Modbus function 1, Read Coil Status/Read Coils.">readCoils</a>(1, 10, readBitSet, <span class="keyword">sizeof</span>(readBitSet) / <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
</pre></div></li>
<li>To write a single discrete value: <div class="fragment"><pre class="fragment">mbusProtocol.<a class="code" href="classMbusMasterFunctions.html#af47fb8f22703b1c270d243a17dd7b0be" title="Modbus function 5, Force Single Coil/Write Coil.">writeCoil</a>(1, 20, 1);
</pre></div></li>
<li>To write multiple discrete values: <div class="fragment"><pre class="fragment">mbusProtocol.<a class="code" href="classMbusMasterFunctions.html#a93b382d702ce98a2224a13d98edeb47a" title="Modbus function 15 (0F Hex), Force Multiple Coils.">forceMultipleCoils</a>(1, 20, <span class="keyword">sizeof</span>(writeBitSet) / <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
</pre></div></li>
<li>To read float values: <div class="fragment"><pre class="fragment">mbusProtocol.<a class="code" href="classMbusMasterFunctions.html#acf8eae638c2ce090d5a9fbabfbb065fa" title="Modbus function 3 for 32-bit float data types, Read Holding Registers/Read Multiple Registers as floa...">readMultipleFloats</a>(1, 100, readFloatSet,
                                <span class="keyword">sizeof</span>(readFloatSet) / <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
</pre></div></li>
<li>To read long integer values: <div class="fragment"><pre class="fragment">mbusProtocol.<a class="code" href="classMbusMasterFunctions.html#a302b75ea21b9600e30ac68bcf81f64aa" title="Modbus function 3 for 32-bit long int data types, Read Holding Registers/Read Multiple Registers as l...">readMultipleLongInts</a>(1, 100, readLongSet,
                                  <span class="keyword">sizeof</span>(readLongSet) / <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>));
</pre></div></li>
</ul>
<p>6. Close the protocol port if not needed any more </p>
<div class="fragment"><pre class="fragment">mbusProtocol.<a class="code" href="classMbusSerialMasterProtocol.html#a99162acbde11d57faf6a154089e920cb" title="Closes an open protocol including any associated communication resources (com ports or sockets)...">closeProtocol</a>();
</pre></div><p>7. Error Handling</p>
<p>Serial protocol errors like slave device failures, transmission failures, checksum errors and time-outs return an error code. The following code snippet can handle and report these errors:</p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">int</span> result;

result = mbusProtocol.<a class="code" href="classMbusMasterFunctions.html#aea74f35a7305faf154b3ee7a46d926f7" title="Modbus function 3, Read Holding Registers/Read Multiple Registers.">readMultipleRegisters</a>(1, 100, dataSetArray, 10);
<span class="keywordflow">if</span> (result != <a class="code" href="group__buserror.html#ga30cbe7caf80689adf2b4359abbddd046" title="Operation was successful.">FTALK_SUCCESS</a>)
{
   fprintf(stderr, <span class="stringliteral">&quot;%s!\n&quot;</span>, <a class="code" href="group__buserror.html#ga86619062eb7bb909d9600901b457143f" title="Translates a numeric error code into a description string.">getBusProtocolErrorText</a>(result));
   <span class="comment">// Stop for fatal errors</span>
   <span class="keywordflow">if</span> (!(result &amp; <a class="code" href="group__buserror.html#ga7a803e248c41302840874c176384b84c" title="Fieldbus protocol error class.">FTALK_BUS_PROTOCOL_ERROR_CLASS</a>))
      <span class="keywordflow">return</span>;
}
</pre></div><p>An automatic retry mechanism is available and can be enabled with mbusProtocol.setRetryCnt(3) before opening the protocol port.</p>
<h2><a class="anchor" id="tcpintegrate"></a>
Using MODBUS/TCP Protocol</h2>
<p>Let's assume we want to talk to a Modbus slave device with unit address 1 and IP address 10.0.0.11.</p>
<p>The registers for reading are in the reference range 4:00100 to 4:00119 and the registers for writing are in the range 4:00200 to 4:00219. The discretes for reading are in the reference range 0:00010 to 0:00019 and the discretes for writing are in the range 0:00020 to 0:00029.</p>
<p>1. Include the library header files </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &quot;MbusTcpMasterProtocol.hpp&quot;</span>
</pre></div><p>2. Device data profile definition</p>
<p>Define the data sets which reflects the slave's data profile by type and size: </p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">short</span> readRegSet[20];
<span class="keywordtype">short</span> writeRegSet[20];
<span class="keywordtype">int</span> readBitSet[10];
<span class="keywordtype">int</span> writeBitSet[10];
</pre></div><p>If you are using floats instead of 16-bit shorts define: </p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">float</span> readFloatSet[10];
<span class="keywordtype">float</span> writeFloatSet[10];
</pre></div><p> Note that because a float occupies two 16-bit registers the array size is half the size it would be for 16-bit shorts!</p>
<p>If you are using 32-bit ints instead of 16-bit shorts define: </p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">long</span> readLongSet[10];
<span class="keywordtype">long</span> writeLongSet[10];
</pre></div><p> Note that because a long occupies two 16-bit registers the array size is half the size it would be for 16-bit shorts!</p>
<p>3. Declare and instantiate a protocol object </p>
<div class="fragment"><pre class="fragment"><a class="code" href="classMbusTcpMasterProtocol.html" title="MODBUS/TCP Master Protocol class.">MbusTcpMasterProtocol</a> mbusProtocol;
</pre></div><p>4. Open the protocol </p>
<div class="fragment"><pre class="fragment">mbusProtocol.<a class="code" href="classMbusTcpMasterProtocol.html#a4bd515ba5c6f5949a59673d0dbb54607" title="Connects to a MODBUS/TCP slave.">openProtocol</a>(<span class="stringliteral">&quot;10.0.0.11&quot;</span>);
</pre></div><p>5. Perform the data transfer functions</p>
<ul>
<li>To read register values: <div class="fragment"><pre class="fragment">mbusProtocol.<a class="code" href="classMbusMasterFunctions.html#aea74f35a7305faf154b3ee7a46d926f7" title="Modbus function 3, Read Holding Registers/Read Multiple Registers.">readMultipleRegisters</a>(1, 100, readRegSet,
                                   <span class="keyword">sizeof</span>(readRegSet) / <span class="keyword">sizeof</span>(<span class="keywordtype">short</span>));
</pre></div></li>
<li>To write a single register value: <div class="fragment"><pre class="fragment">mbusProtocol.<a class="code" href="classMbusMasterFunctions.html#a87c4cbb3073f7caa117e1745e9de731b" title="Modbus function 6, Preset Single Register/Write Single Register.">writeSingleRegister</a>(1, 200, 1234);
</pre></div></li>
<li>To write mutliple register values: <div class="fragment"><pre class="fragment">mbusProtocol.<a class="code" href="classMbusMasterFunctions.html#a8ba7b9150d6b642f44ff1f94679e0dc4" title="Modbus function 16 (10 Hex), Preset Multiple Registers/Write Multiple Registers.">writeMultipleRegisters</a>(1, 200, writeRegSet,
                                    <span class="keyword">sizeof</span>(writeRegSet) / <span class="keyword">sizeof</span>(<span class="keywordtype">short</span>));
</pre></div></li>
<li>To read discrete values: <div class="fragment"><pre class="fragment">mbusProtocol.<a class="code" href="classMbusMasterFunctions.html#ac9cc7e597a6c7036746a15e159d05341" title="Modbus function 1, Read Coil Status/Read Coils.">readCoils</a>(1, 10, readBitSet, <span class="keyword">sizeof</span>(readBitSet) / <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
</pre></div></li>
<li>To write a single discrete value: <div class="fragment"><pre class="fragment">mbusProtocol.<a class="code" href="classMbusMasterFunctions.html#af47fb8f22703b1c270d243a17dd7b0be" title="Modbus function 5, Force Single Coil/Write Coil.">writeCoil</a>(1, 20, 1);
</pre></div></li>
<li>To write multiple discrete values: <div class="fragment"><pre class="fragment">mbusProtocol.<a class="code" href="classMbusMasterFunctions.html#a93b382d702ce98a2224a13d98edeb47a" title="Modbus function 15 (0F Hex), Force Multiple Coils.">forceMultipleCoils</a>(1, 20, writeBitSet,
                                <span class="keyword">sizeof</span>(writeBitSet) / <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
</pre></div></li>
<li>To read float values: <div class="fragment"><pre class="fragment">mbusProtocol.<a class="code" href="classMbusMasterFunctions.html#acf8eae638c2ce090d5a9fbabfbb065fa" title="Modbus function 3 for 32-bit float data types, Read Holding Registers/Read Multiple Registers as floa...">readMultipleFloats</a>(1, 100, readFloatSet,
                                <span class="keyword">sizeof</span>(readFloatSet) / <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
</pre></div></li>
<li>To read long integer values: <div class="fragment"><pre class="fragment">mbusProtocol.<a class="code" href="classMbusMasterFunctions.html#a302b75ea21b9600e30ac68bcf81f64aa" title="Modbus function 3 for 32-bit long int data types, Read Holding Registers/Read Multiple Registers as l...">readMultipleLongInts</a>(1, 100, readLongSet,
                                  <span class="keyword">sizeof</span>(readLongSet) / <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>));
</pre></div></li>
</ul>
<p>6. Close the connection if not needed any more </p>
<div class="fragment"><pre class="fragment">mbusProtocol.<a class="code" href="classMbusTcpMasterProtocol.html#a99162acbde11d57faf6a154089e920cb" title="Closes a TCP/IP connection to a slave and releases any system resources associated with the connectio...">closeProtocol</a>();
</pre></div><p>7. Error Handling</p>
<p>TCP/IP protocol errors like slave failures, TCP/IP connection failures and time-outs return an error code. The following code snippet can handle these errors:</p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">int</span> result;

result = mbusProtocol.<a class="code" href="classMbusMasterFunctions.html#aea74f35a7305faf154b3ee7a46d926f7" title="Modbus function 3, Read Holding Registers/Read Multiple Registers.">readMultipleRegisters</a>(1, 100, dataSetArray, 10);
<span class="keywordflow">if</span> (result != <a class="code" href="group__buserror.html#ga30cbe7caf80689adf2b4359abbddd046" title="Operation was successful.">FTALK_SUCCESS</a>)
{
   fprintf(stderr, <span class="stringliteral">&quot;%s!\n&quot;</span>, <a class="code" href="group__buserror.html#ga86619062eb7bb909d9600901b457143f" title="Translates a numeric error code into a description string.">getBusProtocolErrorText</a>(result));
   <span class="comment">// Stop for fatal errors</span>
   <span class="keywordflow">if</span> (!(result &amp; <a class="code" href="group__buserror.html#ga7a803e248c41302840874c176384b84c" title="Fieldbus protocol error class.">FTALK_BUS_PROTOCOL_ERROR_CLASS</a>))
      <span class="keywordflow">return</span>;
}
</pre></div><p>If the method returns FTALK_CONNECTION_WAS_CLOSED, it signals that the the TCP/IP connection was lost or closed by the remote end. Before using further data and control functions the connection has to be re-opened succesfully. </p>
</div>
<hr size="1"><address style="text-align: right;">
<small>
FieldTalk Modbus Master C++ Library
<br>
Draft Version
</small></address>
</body>
</html>

